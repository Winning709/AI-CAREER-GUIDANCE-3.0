<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Career Guidance System</title>
    <!-- Tailwind CSS CDN for utility classes -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        /* Basic body styling */
        body {
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(to bottom right, #e0f7fa, #c5e1e5); /* Lighter, more vibrant background */
            color: #333;
        }
        /* Custom styles for pre-wrap behavior in prose-like content */
        .prose-like {
            white-space: pre-wrap;
            word-wrap: break-word; /* Ensures long words break and don't overflow */
        }
        /* Modal backdrop */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        /* Modal content */
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); /* shadow-2xl */
            max-width: 48rem; /* max-w-2xl for history, max-w-md for others */
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            border: 1px solid #e2e8f0; /* border border-gray-200 */
        }
        /* Chat specific styles */
        .chat-container {
            height: 400px; /* Fixed height for chat display on larger screens */
            max-height: 60vh; /* Max height for chat on smaller screens */
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1rem;
            background-color: #f8fafc; /* bg-slate-50 */
            display: flex; /* Ensure flex for scroll to bottom */
            flex-direction: column; /* Ensure messages stack vertically */
        }
        .chat-message {
            margin-bottom: 0.75rem;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            max-width: 80%;
            font-size: 0.95rem; /* Default font size for chat messages */
        }
        .chat-message.user {
            background-color: #e0e7ff; /* bg-indigo-100 */
            align-self: flex-end;
            margin-left: auto;
        }
        .chat-message.ai {
            /* Cloud-like design */
            background: linear-gradient(to bottom right, #e0f7fa, #b2ebf2); /* Light blue gradient */
            border: 1px solid #80deea; /* Matching light blue border */
            border-radius: 1.2rem 0.5rem 1.2rem 0.5rem; /* Asymmetrical rounded corners for cloud effect */
            box-shadow: 0 4px 8px rgba(0, 150, 136, 0.1); /* Subtle teal shadow */
            align-self: flex-start;
            margin-right: auto;
            font-size: 1.05rem; /* Increased font size for AI responses */
            padding: 1rem 1.2rem; /* Increased padding */
            display: flex; /* For icon alignment */
            align-items: flex-start; /* Align icon and text at the top */
            gap: 0.75rem; /* Space between icon and text */
        }
        .chat-message.ai .ai-icon {
            color: #00796b; /* Darker teal for icon */
            font-size: 1.2em; /* Slightly larger icon */
            flex-shrink: 0; /* Prevent icon from shrinking */
        }

        /* Styling for the main career guidance output */
        .guidance-output {
            background: linear-gradient(to bottom right, #e3f2fd, #bbdefb); /* Light blue gradient */
            border: 1px solid #90cdf4; /* Blue border */
            border-radius: 1.5rem 0.75rem 1.5rem 0.75rem; /* Asymmetrical rounded corners for cloud effect */
            box-shadow: 0 8px 16px rgba(0, 119, 255, 0.2); /* Stronger shadow */
            padding: 2rem; /* Increased padding */
            margin-top: 2rem; /* mt-8 */
        }

        .guidance-output h2 {
            color: #1565c0; /* Darker blue for main heading */
        }

        /* Styling for individual paragraphs within career guidance output */
        .guidance-output .prose-content p {
            background-color: rgba(255, 255, 255, 0.9); /* More opaque white for inner paragraphs */
            padding: 0.9rem 1.4rem; /* Adjusted padding */
            border-radius: 0.75rem; /* Slightly less rounded */
            margin-bottom: 0.8rem; /* Adjusted space between paragraphs */
            border: 1px solid rgba(144, 205, 244, 0.5); /* Lighter border, softer */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08); /* Softer, more subtle shadow */
            line-height: 1.65; /* Adjusted line height for readability */
            font-size: 1.08rem; /* Adjusted font size for readability */
            color: #2d3748; /* Darker gray for better contrast */
            text-shadow: none; /* Remove subtle text shadow for cleaner look */
        }
        .guidance-output .prose-content p:last-child {
            margin-bottom: 0; /* No margin after the last paragraph */
        }

        /* Styles for headings within prose-content */
        .prose-content h3 {
            font-size: 1.4rem; /* h3 equivalent, slightly larger */
            font-weight: bold;
            color: #2b6cb0; /* Matching blue for headings */
            margin-top: 1.8rem; /* More space above headings */
            margin-bottom: 0.9rem; /* More space below headings */
            border-bottom: 1px solid #a7d9f7; /* Subtle underline */
            padding-bottom: 0.4rem;
        }

        /* Styles for lists within prose-content */
        .prose-content ul, .prose-content ol {
            margin-left: 1.6rem; /* Adjusted indent */
            margin-bottom: 0.9rem; /* Adjusted space below lists */
            list-style-position: outside; /* Ensure bullets are outside padding */
        }
        .prose-content ul li, .prose-content ol li {
            margin-bottom: 0.6rem; /* Adjusted space between list items */
            font-size: 1.05rem; /* Adjusted font size */
            line-height: 1.55;
            color: #4a5568; /* Slightly darker gray for list items */
        }
        .prose-content ul {
            list-style-type: disc;
        }
        .prose-content ol {
            list-style-type: decimal;
        }

        /* Styles for strong/bold and emphasis/italic */
        .prose-content strong {
            font-weight: bold;
            color: #1a202c; /* Darker color for emphasis */
        }
        .prose-content em {
            font-style: italic;
            color: #4a5568;
        }

        /* Styling for the skill development plan output */
        .skill-plan-output {
            background: linear-gradient(to bottom right, #fce4ec, #f8bbd0); /* Light pink/rose gradient */
            border: 1px solid #ef9a9a; /* Pink border */
            border-radius: 0.75rem 1.5rem 0.75rem 1.5rem; /* Asymmetrical rounded corners, opposite of guidance-output */
            box-shadow: 0 8px 16px rgba(233, 30, 99, 0.2); /* Stronger pink shadow */
            padding: 2rem;
            margin-top: 2rem;
        }

        .skill-plan-output h2 {
            color: #c2185b; /* Darker pink/red */
        }

        /* Styling for individual paragraphs within skill development plan output */
        .skill-plan-output .prose-content p {
            background-color: rgba(255, 255, 255, 0.9); /* More opaque white for inner paragraphs */
            padding: 0.9rem 1.4rem;
            border-radius: 0.75rem;
            margin-bottom: 0.8rem;
            border: 1px solid rgba(248, 187, 208, 0.5); /* Softer border */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
            line-height: 1.65;
            font-size: 1.08rem;
            color: #2d3748;
            text-shadow: none;
        }
        .skill-plan-output .prose-content p:last-child {
            margin-bottom: 0;
        }

        /* Detailed explanation output */
        .detailed-explanation-output {
            background: linear-gradient(to bottom right, #e8f5e9, #c8e6c9); /* Light green gradient */
            border: 1px solid #a5d6a7; /* Green border */
            box-shadow: 0 6px 12px rgba(76, 175, 80, 0.15); /* Soft green shadow */
        }
        .detailed-explanation-output h3 {
            color: #388e3c; /* Darker green */
            border-bottom-color: #c8e6c9; /* Matching light green underline */
        }
        .detailed-explanation-output .prose-content p {
            background-color: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(165, 214, 167, 0.5);
        }

        /* Responsive adjustments for smaller screens */
        @media (max-width: 768px) {
            .chat-container {
                height: 300px; /* Adjust height for smaller screens */
                max-height: 50vh;
            }
            .chat-message {
                font-size: 0.9rem; /* Slightly smaller font on mobile */
            }
            .chat-message.ai {
                font-size: 1rem; /* Slightly smaller AI font on mobile */
                padding: 0.8rem 1rem; /* Adjust padding for mobile */
                gap: 0.5rem; /* Adjust gap for mobile */
            }
            .chat-message.ai .ai-icon {
                font-size: 1.1em;
            }
            .modal-content {
                padding: 1.5rem;
                margin: 1rem; /* Add some margin on very small screens */
            }
            .guidance-output, .skill-plan-output, .detailed-explanation-output {
                padding: 1.5rem; /* Adjust padding for mobile */
            }
            .guidance-output .prose-content p,
            .skill-plan-output .prose-content p,
            .detailed-explanation-output .prose-content p {
                padding: 0.7rem 1.1rem; /* Adjust padding for mobile */
                font-size: 1rem; /* Adjust font size for mobile */
            }
            .prose-content h3 {
                font-size: 1.25rem; /* Adjust heading size for mobile */
            }
            .prose-content ul li, .prose-content ol li {
                font-size: 1rem; /* Adjust list item font size for mobile */
            }
        }
    </style>
</head>
<body>
    <div id="app-root" class="w-full flex justify-center items-center p-4 sm:p-6 lg:p-8">
        <!-- The application UI will be rendered here by JavaScript -->
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, sendEmailVerification, sendPasswordResetEmail, updateProfile } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, query, getDocs, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Configuration (from your previous input)
        const firebaseConfig = {
            apiKey: "AIzaSyCGsgL070qfh0KqwoFZLjQ3_hrYcBYxeI8",
            authDomain: "ai-career-guide-8af0f.firebaseapp.com",
            projectId: "ai-career-guide-8af0f",
            storageBucket: "ai-career-guide-8af0f.firebasestorage.app",
            messagingSenderId: "977509307025",
            appId: "1:977509307025:web:834e268e4ef1d36c2ca530",
            measurementId: "G-189P4BG2VX"
        };

        let app;
        let auth;
        let db;
        let currentUser = null;
        let currentUserId = null;
        let currentProjectId = null;
        let isAuthInitialized = false; // Flag to track Firebase initialization
        let username = ''; // New state for username
        // Removed geminiApiKey state as it will be hardcoded

        // Get the root element to render the app
        const appRoot = document.getElementById('app-root');

        // State variables for the UI (managed manually, no React hooks)
        let currentView = 'loading'; // 'loading', 'login', 'register', 'main', 'verify_email'
        let email = '';
        let password = '';
        let authError = '';
        let isLoading = false; // Global loading state for buttons/actions
        let isGeneratingDetailedExplanation = false; // New loading state for detailed explanation

        // Conversational state
        let conversationHistory = []; // Stores { role: 'user' | 'model', text: string }
        let currentQuestionType = 'initial'; // 'initial', 'interests', 'skills', 'goals', 'finished_questions'
        let userResponses = {
            interests: '',
            skills: '',
            goals: ''
        };
        let currentUserInput = ''; // For the chat input field

        let careerGuidance = '';
        let suggestedCareers = []; // New state to store parsed career suggestions
        let detailedCareerExplanation = ''; // New state for detailed explanation
        let guidanceError = '';
        let pastGuidance = [];
        let showPastGuidanceModal = false;
        let showDeleteConfirmModal = false;
        let guidanceToDelete = null;

        let skillPlan = '';
        let isSkillPlanLoading = false;
        let skillPlanError = '';
        let showForgotPasswordModal = false;
        let forgotPasswordEmail = '';
        let forgotPasswordMessage = '';

        // --- UI Rendering Function ---
        function renderUI() {
            console.log("renderUI called, currentView:", currentView);
            appRoot.innerHTML = ''; // Clear previous UI
            let htmlContent = '';

            if (currentView === 'loading') {
                htmlContent = `
                    <div class="min-h-screen bg-gradient-to-br from-purple-100 to-indigo-200 flex items-center justify-center p-4 font-sans w-full">
                        <div class="text-center text-indigo-800 text-2xl font-bold flex items-center">
                            <svg class="animate-spin h-8 w-8 mr-3 text-indigo-600" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            Loading application...
                        </div>
                    </div>
                `;
            } else if (currentView === 'login' || currentView === 'register' || currentView === 'verify_email') {
                htmlContent = `
                    <div class="min-h-screen bg-gradient-to-br from-purple-100 to-indigo-200 flex flex-col items-center justify-center p-4 sm:p-6 font-sans w-full">
                        <h2 class="text-3xl sm:text-4xl lg:text-4xl font-extrabold text-center text-indigo-800 mb-8">
                            AI Career Guidance System
                        </h2>
                        <div class="bg-white rounded-xl shadow-2xl p-6 sm:p-8 w-full max-w-md border border-gray-200">
                            ${currentView === 'verify_email' ? `
                                <h1 class="text-3xl font-extrabold text-center text-indigo-800 mb-6">Email Verification Required</h1>
                                <p class="text-gray-700 text-center mb-4">
                                    Please check your email (${email}) for a verification link. Also check your spam or junk section. You must verify your email to access the career guidance system.
                                </p>
                                <button
                                    id="resendVerificationBtn"
                                    class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-500 focus:ring-opacity-50 transition duration-300 ease-in-out transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center ${isLoading ? 'opacity-50 cursor-not-allowed' : ''}"
                                    ${isLoading ? 'disabled' : ''}
                                >
                                    ${isLoading ? `
                                        <svg class="animate-spin h-5 w-5 mr-3 text-white" viewBox="0 0 24 24">
                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                    ` : 'Resend Verification Email'}
                                </button>
                                <button
                                    id="backToLoginBtn"
                                    class="w-full bg-gray-300 text-gray-800 font-bold py-3 px-6 rounded-lg hover:bg-gray-400 focus:outline-none focus:ring-4 focus:ring-gray-300 transition duration-300 ease-in-out transform hover:scale-105 mt-4"
                                >
                                    Back to Login
                                </button>
                            ` : `
                                <h1 class="text-4xl font-extrabold text-center text-indigo-800 mb-8">
                                    ${currentView === 'login' ? 'Login' : 'Register'}
                                </h1>
                                <form id="authForm" class="space-y-6">
                                    ${currentView === 'register' ? `
                                        <div>
                                            <label for="username" class="block text-lg font-semibold text-gray-700 mb-2">
                                                Username:
                                            </label>
                                            <input
                                                type="text"
                                                id="username"
                                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition duration-200 ease-in-out"
                                                placeholder="Choose a unique username"
                                                value="${username}"
                                                required
                                            />
                                        </div>
                                    ` : ''}
                                    <div>
                                        <label for="email" class="block text-lg font-semibold text-gray-700 mb-2">
                                            ${currentView === 'login' ? 'Username or Email:' : 'Email:'}
                                        </label>
                                        <input
                                            type="text"
                                            id="email"
                                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition duration-200 ease-in-out"
                                            placeholder="${currentView === 'login' ? 'your.username or your.email@example.com' : 'your.email@example.com'}"
                                            value="${email}"
                                            required
                                        />
                                    </div>
                                    <div>
                                        <label for="password" class="block text-lg font-semibold text-gray-700 mb-2">
                                            Password:
                                        </label>
                                        <input
                                            type="password"
                                            id="password"
                                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition duration-200 ease-in-out"
                                            placeholder="••••••••"
                                            value="${password}"
                                            required
                                        />
                                    </div>
                                    ${authError ? `
                                        <div class="p-3 rounded-lg text-sm ${authError.includes('successful') ? 'bg-green-100 border border-green-400 text-green-700' : 'bg-red-100 border border-red-400 text-red-700'}">
                                            ${authError}
                                        </div>
                                    ` : ''}
                                    <button
                                        type="submit"
                                        class="w-full bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50 transition duration-300 ease-in-out transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center ${isLoading ? 'opacity-50 cursor-not-allowed' : ''}"
                                        ${isLoading ? 'disabled' : ''}
                                    >
                                        ${isLoading ? `
                                            <svg class="animate-spin h-5 w-5 mr-3 text-white" viewBox="0 0 24 24">
                                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                    ` : (currentView === 'login' ? 'Login' : 'Register')}
                                    </button>
                                </form>
                                <div class="mt-6 text-center">
                                    ${currentView === 'login' ? `
                                        <p class="text-gray-600">
                                            Don't have an account?
                                            <button id="switchToRegister" class="text-indigo-600 hover:text-indigo-800 font-semibold focus:outline-none">
                                                Register here
                                            </button>
                                        </p>
                                        <button id="forgotPasswordBtn" class="text-sm text-indigo-600 hover:text-indigo-800 font-semibold focus:outline-none mt-2 block mx-auto w-auto">
                                            Forgot Password?
                                        </button>
                                    ` : `
                                        <p class="text-gray-600">
                                            Already have an account?
                                            <button id="switchToLogin" class="text-indigo-600 hover:text-indigo-800 font-semibold focus:outline-none">
                                                Login here
                                            </button>
                                        </p>
                                    `}
                                </div>
                            `}
                        </div>
                        ${showForgotPasswordModal ? `
                            <div class="modal-backdrop">
                                <div class="modal-content w-full max-w-md">
                                    <h3 class="text-2xl font-bold text-indigo-800 mb-4">Reset Password</h3>
                                    <button id="closeForgotPasswordModal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-2xl font-bold w-auto">
                                        &times;
                                    </button>
                                    <p class="text-gray-700 mb-4">Enter your email address to receive a password reset link.</p>
                                    <input
                                        type="email"
                                        id="forgotPasswordEmailInput"
                                        placeholder="your.email@example.com"
                                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition duration-200 ease-in-out mb-4"
                                        value="${forgotPasswordEmail}"
                                        required
                                    />
                                    ${forgotPasswordMessage ? `
                                        <div class="p-3 rounded-lg text-sm mb-4 ${forgotPasswordMessage.type === 'success' ? 'bg-green-100 border border-green-400 text-green-700' : 'bg-red-100 border border-red-400 text-red-700'}">
                                            ${forgotPasswordMessage.text}
                                        </div>
                                    ` : ''}
                                    <button
                                        id="sendResetEmailBtn"
                                        class="w-full bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50 transition duration-300 ease-in-out transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center ${isLoading ? 'opacity-50 cursor-not-allowed' : ''}"
                                        ${isLoading ? 'disabled' : ''}
                                    >
                                        ${isLoading ? `
                                            <svg class="animate-spin h-5 w-5 mr-3 text-white" viewBox="0 0 24 24">
                                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                    ` : 'Send Reset Email'}
                                    </button>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            } else if (currentView === 'main') {
                // Function to convert Markdown to HTML
                const markdownToHtml = (markdown) => {
                    if (!markdown) return '';

                    let html = markdown;

                    // Convert headings (h2, h3)
                    html = html.replace(/^###\s*(.*)$/gm, '<h3>$1</h3>');
                    html = html.replace(/^##\s*(.*)$/gm, '<h2>$1</h2>'); // Not used in current prompt, but good to have

                    // Convert bold and italics (must be before paragraphs to avoid issues)
                    html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); // Bold
                    html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');     // Italic

                    // Convert bullet points (unordered lists)
                    html = html.replace(/^- (.*)$/gm, '<li>$1</li>');
                    html = html.replace(/^(<li>.*<\/li>\s*)+/gm, '<ul>$&</ul>');

                    // Convert numbered lists (ordered lists)
                    html = html.replace(/^\d+\.\s*(.*)$/gm, '<li>$1</li>');
                    html = html.replace(/^(<li>.*<\/li>\s*)+/gm, '<ol>$&</ol>');

                    // Split by double newlines to form distinct blocks (paragraphs, lists, headings)
                    // Then process each block. This prevents wrapping lists/headings in <p> tags.
                    const blocks = html.split('\n\n');
                    let processedHtml = blocks.map(block => {
                        // Check if block already starts with a known HTML tag (h, ul, ol, li)
                        if (block.trim().startsWith('<h') || block.trim().startsWith('<ul') || block.trim().startsWith('<ol') || block.trim().startsWith('<li')) {
                            return block; // Already processed as a block element
                        }
                        // If it's not a block element, treat it as a paragraph
                        return `<p>${block.split('\n').filter(line => line.trim() !== '').join('<br>')}</p>`;
                    }).join('');

                    return processedHtml;
                };


                htmlContent = `
                    <div class="min-h-screen bg-gradient-to-br from-purple-100 to-indigo-200 flex flex-col items-center justify-center p-4 sm:p-6 font-sans w-full">
                        <div class="bg-white rounded-xl shadow-2xl p-6 sm:p-8 w-full max-w-3xl border border-gray-200 mb-4">
                            <div class="flex flex-col sm:flex-row justify-between items-center mb-6 space-y-4 sm:space-y-0">
                                <h1 class="text-3xl sm:text-4xl font-extrabold text-indigo-800 text-center sm:text-left flex-grow-0 sm:flex-grow">
                                    AI Career Guidance
                                </h1>
                                <div class="flex flex-wrap items-center justify-center sm:justify-end space-x-2 sm:space-x-4 ml-auto">
                                    ${currentUser && username ? `
                                        <span class="text-gray-700 text-sm sm:text-md font-medium text-center sm:text-right">
                                            Welcome, ${username}!
                                        </span>
                                    ` : ''}
                                    ${currentUserId ? `
                                        <span class="text-gray-500 text-xs sm:text-sm text-center sm:text-right">
                                            User ID: ${currentUserId.substring(0, 8)}...
                                        </span>
                                    ` : ''}
                                    <button
                                        id="logoutBtn"
                                        class="bg-red-500 text-white font-bold py-2 px-3 sm:px-4 rounded-lg hover:bg-red-600 focus:outline-none focus:ring-4 focus:ring-red-300 transition duration-300 ease-in-out ${isLoading ? 'opacity-50 cursor-not-allowed' : ''}"
                                        ${isLoading ? 'disabled' : ''}
                                    >
                                        Logout
                                    </button>
                                </div>
                            </div>

                            <!-- Removed Gemini API Key Input -->

                            <!-- Chat Interface -->
                            <div class="chat-container flex flex-col space-y-3">
                                ${conversationHistory.map(msg => `
                                    <div class="chat-message ${msg.role === 'user' ? 'user' : 'ai'}">
                                        ${msg.role === 'ai' ? '<i class="fas fa-robot ai-icon"></i>' : ''}
                                        <div class="prose-content">${markdownToHtml(msg.text)}</div>
                                    </div>
                                `).join('')}
                                ${isLoading || isGeneratingDetailedExplanation ? `
                                    <div class="chat-message ai">
                                        <p class="flex items-center">
                                            <svg class="animate-spin h-4 w-4 mr-2 text-indigo-600" viewBox="0 0 24 24">
                                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                            </svg>
                                            AI is typing...
                                        </p>
                                    </div>
                                ` : ''}
                            </div>

                            <div class="flex flex-col sm:flex-row mt-4 space-y-2 sm:space-y-0 sm:space-x-2">
                                <textarea
                                    id="chatInput"
                                    class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition duration-200 ease-in-out resize-y min-h-12 max-h-32"
                                    placeholder="Type your response here..."
                                    rows="1"
                                    value="${currentUserInput}"
                                ></textarea>
                                <button
                                    id="sendMessageBtn"
                                    class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50 transition duration-300 ease-in-out transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed"
                                    ${isLoading || isGeneratingDetailedExplanation ? 'disabled' : ''}
                                >
                                    Send
                                </button>
                            </div>

                            ${guidanceError ? `
                                <div class="mt-8 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg">
                                    <p class="font-semibold">Error:</p>
                                    <p>${guidanceError}</p>
                                </div>
                            ` : ''}

                            ${careerGuidance ? `
                                <div class="guidance-output">
                                    <h2 class="text-xl sm:text-2xl font-bold text-blue-800 mb-4">Your Career Guidance:</h2>
                                    <div class="prose-content text-gray-800 leading-relaxed">
                                        ${markdownToHtml(careerGuidance)}
                                    </div>

                                    ${suggestedCareers.length > 0 ? `
                                        <div class="mt-6">
                                            <h3 class="text-lg font-semibold text-indigo-700 mb-3">Explore Specific Careers:</h3>
                                            <div class="flex flex-wrap gap-3">
                                                ${suggestedCareers.map(career => `
                                                    <button
                                                        class="select-career-btn bg-teal-600 text-white font-bold py-2 px-4 rounded-full hover:bg-teal-700 focus:outline-none focus:ring-4 focus:ring-teal-300 transition duration-300 ease-in-out transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed"
                                                        data-career-name="${career}"
                                                        ${isGeneratingDetailedExplanation ? 'disabled' : ''}
                                                    >
                                                        ${career}
                                                    </button>
                                                `).join('')}
                                            </div>
                                            ${isGeneratingDetailedExplanation ? `
                                                <p class="text-indigo-600 mt-3 flex items-center">
                                                    <svg class="animate-spin h-4 w-4 mr-2 text-indigo-600" viewBox="0 0 24 24">
                                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                                    </svg>
                                                    Generating detailed explanation...
                                                </p>
                                            ` : ''}
                                        </div>
                                    ` : ''}

                                    ${detailedCareerExplanation ? `
                                        <div class="detailed-explanation-output mt-8 p-6 bg-blue-50 rounded-xl border border-blue-200 shadow-md">
                                            <h3 class="text-xl font-bold text-blue-700 mb-4">Detailed Explanation:</h3>
                                            <div class="prose-content text-gray-800 leading-relaxed">
                                                ${markdownToHtml(detailedCareerExplanation)}
                                            </div>
                                        </div>
                                    ` : ''}

                                    <button
                                        id="getSkillPlanBtn"
                                        class="w-full bg-purple-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-purple-700 focus:outline-none focus:ring-4 focus:ring-purple-500 focus:ring-opacity-50 transition duration-300 ease-in-out transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center mt-4 ${isSkillPlanLoading ? 'opacity-50 cursor-not-allowed' : ''}"
                                        ${isSkillPlanLoading ? 'disabled' : ''}
                                    >
                                        ${isSkillPlanLoading ? `
                                            <svg class="animate-spin h-5 w-5 mr-3 text-white" viewBox="0 0 24 24">
                                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                    ` : '✨ Generate Skill Development Plan'}
                                    </button>
                                </div>
                            ` : ''}

                            ${skillPlanError ? `
                                <div class="mt-8 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg">
                                    <p class="font-semibold">Error:</p>
                                    <p>${skillPlanError}</p>
                                </div>
                            ` : ''}

                            ${skillPlan ? `
                                <div class="skill-plan-output">
                                    <h2 class="text-xl sm:text-2xl font-bold text-purple-800 mb-4">Your Skill Development Plan:</h2>
                                    <div class="prose-content text-gray-800 leading-relaxed">
                                        ${markdownToHtml(skillPlan)}
                                    </div>
                                </div>
                            ` : ''}
                        </div>

                        <!-- Past Guidance Section -->
                        <div class="w-full max-w-3xl bg-white rounded-xl shadow-2xl p-6 sm:p-8 border border-gray-200">
                            <div class="flex flex-col sm:flex-row justify-between items-center mb-4 space-y-2 sm:space-y-0">
                                <h2 class="text-xl sm:text-2xl font-bold text-indigo-800">Past Guidance</h2>
                                <div class="flex flex-wrap justify-center sm:justify-end space-x-2">
                                    <button
                                        id="viewHistoryBtn"
                                        class="bg-blue-500 text-white font-bold py-2 px-3 sm:px-4 rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-4 focus:ring-blue-300 transition duration-300 ease-in-out"
                                    >
                                        View History
                                    </button>
                                    <button
                                        id="restartConversationBtn"
                                        class="bg-green-500 text-white font-bold py-2 px-3 sm:px-4 rounded-lg hover:bg-green-600 focus:outline-none focus:ring-4 focus:ring-green-300 transition duration-300 ease-in-out"
                                    >
                                        Restart Conversation
                                    </button>
                                </div>
                            </div>
                            ${pastGuidance.length === 0 ? `
                                <p class="text-gray-600">No past guidance found. Generate some above!</p>
                            ` : `
                                <ul class="space-y-3">
                                    ${pastGuidance.slice(0, 3).map(item => `
                                        <li class="bg-gray-50 p-3 rounded-lg border border-gray-200 flex flex-col sm:flex-row justify-between items-start sm:items-center">
                                            <p class="text-gray-700 text-sm font-medium mb-1 sm:mb-0">
                                                ${new Date(item.timestamp).toLocaleString()}: ${item.interests.substring(0, 50)}${item.interests.length > 50 ? '...' : ''}
                                            </p>
                                            <button
                                                data-id="${item.id}"
                                                class="load-guidance-btn text-indigo-600 hover:text-indigo-800 text-sm font-semibold"
                                            >
                                                Load
                                            </button>
                                        </li>
                                    `).join('')}
                                </ul>
                            `}
                        </div>

                        <!-- Past Guidance Modal -->
                        ${showPastGuidanceModal ? `
                            <div class="modal-backdrop">
                                <div class="modal-content w-full max-w-2xl">
                                    <h2 class="text-2xl sm:text-3xl font-bold text-indigo-800 mb-6 text-center">Your Guidance History</h2>
                                    <button id="closePastGuidanceModal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-2xl font-bold w-auto">
                                        &times;
                                    </button>
                                    ${pastGuidance.length === 0 ? `
                                        <p class="text-gray-600 text-center">No past guidance found. Generate some above!</p>
                                    ` : `
                                        <ul class="space-y-4">
                                            ${pastGuidance.map(item => `
                                                <li class="bg-gray-50 p-4 rounded-lg border border-gray-200 shadow-sm">
                                                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-2">
                                                        <p class="text-sm text-gray-500 mb-1 sm:mb-0">
                                                            ${new Date(item.timestamp).toLocaleString()}
                                                        </p>
                                                        <div class="flex space-x-2">
                                                            <button
                                                                data-id="${item.id}"
                                                                class="load-guidance-btn-modal bg-indigo-500 text-white text-sm py-1 px-3 rounded-md hover:bg-indigo-600 transition duration-200"
                                                            >
                                                                Load
                                                            </button>
                                                            <button
                                                                data-id="${item.id}"
                                                                class="delete-guidance-btn bg-red-500 text-white text-sm py-1 px-3 rounded-md hover:bg-red-600 transition duration-200"
                                                            >
                                                                Delete
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <p class="text-gray-800 font-semibold mb-2">
                                                        Interests: <span class="font-normal">${item.interests.substring(0, 100)}${item.interests.length > 100 ? '...' : ''}</span>
                                                    </p>
                                                    <p class="text-gray-800 font-semibold">
                                                        Skills: <span class="font-normal">${item.skills.substring(0, 100)}${item.skills.length > 100 ? '...' : ''}</span>
                                                    </p>
                                                    <div class="mt-3 text-gray-700 text-sm prose-like">
                                                        ${item.guidance.substring(0, 200)}${item.guidance.length > 200 ? '...' : ''}
                                                    </div>
                                                </li>
                                            `).join('')}
                                        </ul>
                                    `}
                                </div>
                            </div>
                        ` : ''}

                        <!-- Delete Confirmation Modal -->
                        ${showDeleteConfirmModal && guidanceToDelete ? `
                            <div class="modal-backdrop">
                                <div class="modal-content w-full max-w-md">
                                    <h3 class="text-2xl font-bold text-red-700 mb-4">Confirm Deletion</h3>
                                    <p class="text-gray-700 mb-6">
                                        Are you sure you want to delete this guidance entry from
                                        <span class="font-semibold">${new Date(guidanceToDelete.timestamp).toLocaleString()}</span>?
                                        This action cannot be undone.
                                    </p>
                                    <div class="flex justify-end space-x-4">
                                        <button
                                            id="cancelDeleteBtn"
                                            class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-400 transition duration-200"
                                        >
                                            Cancel
                                        </button>
                                        <button
                                            id="confirmDeleteBtn"
                                            class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition duration-200"
                                        >
                                            Delete
                                        </button>
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }
            appRoot.innerHTML = htmlContent;
            // Use setTimeout to ensure DOM elements are rendered before attaching listeners
            setTimeout(attachEventListeners, 0);
            // Scroll chat to bottom if it's the main view
            if (currentView === 'main') {
                const chatContainer = document.querySelector('.chat-container');
                if (chatContainer) {
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }
            }
        }

        // --- Event Listener Attachment ---
        function attachEventListeners() {
            console.log("Attaching event listeners. (Delayed)");
            try {
                // Attach listeners based on the current view
                if (currentView === 'login' || currentView === 'register') {
                    // Auth Form elements
                    const authForm = document.getElementById('authForm');
                    if (authForm) {
                        console.log("Auth form found, attaching submit listener.");
                        authForm.onsubmit = async (e) => {
                            e.preventDefault();
                            if (currentView === 'register') {
                                username = document.getElementById('username').value.trim();
                            }
                            email = document.getElementById('email').value.trim();
                            password = document.getElementById('password').value;
                            if (currentView === 'login') {
                                await handleLogin();
                            } else {
                                await handleRegister();
                            }
                        };
                        // Update state variables on input
                        const usernameInput = document.getElementById('username');
                        if (usernameInput) usernameInput.oninput = (e) => { username = e.target.value; };

                        const emailInput = document.getElementById('email');
                        if (emailInput) emailInput.oninput = (e) => { email = e.target.value; };

                        const passwordInput = document.getElementById('password');
                        if (passwordInput) passwordInput.oninput = (e) => { password = e.target.value; };
                    }

                    const switchToRegisterBtn = document.getElementById('switchToRegister');
                    if (switchToRegisterBtn) {
                        switchToRegisterBtn.onclick = () => {
                            currentView = 'register';
                            authError = '';
                            email = ''; // Clear email/username for new form
                            username = '';
                            password = '';
                            renderUI();
                        };
                    }
                    const switchToLoginBtn = document.getElementById('switchToLogin');
                    if (switchToLoginBtn) {
                        switchToLoginBtn.onclick = () => {
                            currentView = 'login';
                            authError = '';
                            email = ''; // Clear email/username for new form
                            username = '';
                            password = '';
                            renderUI();
                        };
                    }

                    const forgotPasswordBtn = document.getElementById('forgotPasswordBtn');
                    if (forgotPasswordBtn) {
                        forgotPasswordBtn.onclick = () => {
                            showForgotPasswordModal = true;
                            forgotPasswordEmail = email; // Pre-fill with current email
                            forgotPasswordMessage = '';
                            renderUI();
                        };
                    }

                    const closeForgotPasswordModalBtn = document.getElementById('closeForgotPasswordModal');
                    if (closeForgotPasswordModalBtn) {
                        closeForgotPasswordModalBtn.onclick = () => {
                            showForgotPasswordModal = false;
                            forgotPasswordMessage = '';
                            forgotPasswordEmail = '';
                            renderUI();
                        };
                    }

                    const forgotPasswordEmailInput = document.getElementById('forgotPasswordEmailInput');
                    if (forgotPasswordEmailInput) {
                        forgotPasswordEmailInput.oninput = (e) => { forgotPasswordEmail = e.target.value; };
                    }

                    const sendResetEmailBtn = document.getElementById('sendResetEmailBtn');
                    if (sendResetEmailBtn) {
                        sendResetEmailBtn.onclick = handleForgotPassword;
                    }
                } else if (currentView === 'verify_email') {
                    const resendVerificationBtn = document.getElementById('resendVerificationBtn');
                    if (resendVerificationBtn) {
                        resendVerificationBtn.onclick = handleResendVerificationEmail;
                    }
                    const backToLoginBtn = document.getElementById('backToLoginBtn');
                    if (backToLoginBtn) {
                        backToLoginBtn.onclick = () => {
                            currentView = 'login';
                            authError = '';
                            renderUI();
                        };
                    }
                }
                else if (currentView === 'main') {
                    // Main App UI elements
                    const logoutBtn = document.getElementById('logoutBtn');
                    if (logoutBtn) {
                        logoutBtn.onclick = handleLogout;
                    }

                    // Removed geminiApiKeyInput listener

                    const chatInput = document.getElementById('chatInput');
                    const sendMessageBtn = document.getElementById('sendMessageBtn');

                    if (chatInput) {
                        chatInput.value = currentUserInput; // Ensure input field reflects state
                        chatInput.oninput = (e) => { currentUserInput = e.target.value; };
                        chatInput.onkeydown = (e) => {
                            if (e.key === 'Enter' && !e.shiftKey) {
                                e.preventDefault(); // Prevent newline in textarea
                                if (currentUserInput.trim() !== '' && !isLoading) {
                                    handleSendMessage();
                                }
                            }
                        };
                    }
                    if (sendMessageBtn) {
                        sendMessageBtn.onclick = () => {
                            if (currentUserInput.trim() !== '' && !isLoading) {
                                handleSendMessage();
                            }
                        };
                    }

                    const getSkillPlanBtn = document.getElementById('getSkillPlanBtn');
                    if (getSkillPlanBtn) {
                        getSkillPlanBtn.onclick = handleGetSkillPlan;
                    }

                    const viewHistoryBtn = document.getElementById('viewHistoryBtn');
                    if (viewHistoryBtn) {
                        viewHistoryBtn.onclick = () => {
                            showPastGuidanceModal = true;
                            renderUI();
                        };
                    }

                    const closePastGuidanceModalBtn = document.getElementById('closePastGuidanceModal');
                    if (closePastGuidanceModalBtn) {
                        closePastGuidanceModalBtn.onclick = () => {
                            showPastGuidanceModal = false;
                            renderUI();
                        };
                    }

                    const restartConversationBtn = document.getElementById('restartConversationBtn');
                    if (restartConversationBtn) {
                        restartConversationBtn.onclick = restartConversation;
                    }

                    // Load buttons in main view
                    document.querySelectorAll('.load-guidance-btn').forEach(button => {
                        button.onclick = (e) => {
                            const idToLoad = e.target.dataset.id;
                            const item = pastGuidance.find(g => g.id === idToLoad);
                            if (item) {
                                // Reset conversation when loading past guidance
                                conversationHistory = [];
                                currentQuestionType = 'finished_questions'; // Indicate no more questions to ask
                                userResponses = {
                                    interests: item.interests,
                                    skills: item.skills,
                                    goals: item.goals
                                };
                                careerGuidance = item.guidance;
                                skillPlan = ''; // Clear skill plan when loading new guidance
                                skillPlanError = '';
                                detailedCareerExplanation = ''; // Clear detailed explanation
                                suggestedCareers = parseSuggestedCareers(item.guidance); // Repopulate suggested careers
                                conversationHistory.push({ role: 'model', text: `Loaded past guidance from ${new Date(item.timestamp).toLocaleString()}.` });
                                conversationHistory.push({ role: 'model', text: `Here's the guidance based on your interests: "${item.interests}", skills: "${item.skills}", and goals: "${item.goals}".` });
                                renderUI();
                            }
                        };
                    });

                    // Load buttons in modal
                    document.querySelectorAll('.load-guidance-btn-modal').forEach(button => {
                        button.onclick = (e) => {
                            const idToLoad = e.target.dataset.id;
                            const item = pastGuidance.find(g => g.id === idToLoad);
                            if (item) {
                                // Reset conversation when loading past guidance
                                conversationHistory = [];
                                currentQuestionType = 'finished_questions'; // Indicate no more questions to ask
                                userResponses = {
                                    interests: item.interests,
                                    skills: item.skills,
                                    goals: item.goals
                                };
                                careerGuidance = item.guidance;
                                skillPlan = ''; // Clear skill plan when loading new guidance
                                skillPlanError = '';
                                detailedCareerExplanation = ''; // Clear detailed explanation
                                suggestedCareers = parseSuggestedCareers(item.guidance); // Repopulate suggested careers
                                showPastGuidanceModal = false; // Close modal after loading
                                conversationHistory.push({ role: 'model', text: `Loaded past guidance from ${new Date(item.timestamp).toLocaleString()}.` });
                                conversationHistory.push({ role: 'model', text: `Here's the guidance based on your interests: "${item.interests}", skills: "${item.skills}", and goals: "${item.goals}".` });
                                renderUI();
                            }
                        };
                    });

                    // Delete buttons in modal
                    document.querySelectorAll('.delete-guidance-btn').forEach(button => {
                        button.onclick = (e) => {
                            const idToDelete = e.target.dataset.id;
                            guidanceToDelete = pastGuidance.find(g => g.id === idToDelete);
                            showDeleteConfirmModal = true;
                            renderUI();
                        };
                    });

                    const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
                    if (cancelDeleteBtn) {
                        cancelDeleteBtn.onclick = () => {
                            showDeleteConfirmModal = false;
                            guidanceToDelete = null;
                            renderUI();
                        };
                    }

                    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
                    if (confirmDeleteBtn) {
                        confirmDeleteBtn.onclick = async () => {
                            if (guidanceToDelete) {
                                await handleDeleteGuidance(guidanceToDelete.id);
                            }
                        };
                    }

                    // New: Attach listeners for career selection buttons
                    document.querySelectorAll('.select-career-btn').forEach(button => {
                        button.onclick = (e) => {
                            const careerName = e.target.dataset.careerName;
                            handleCareerSelection(careerName);
                        };
                    });
                }
            } catch (error) {
                console.error("Error attaching event listeners:", error);
            }
        }

        // --- Firebase Initialization ---
        function initializeFirebase() {
            console.log("Initializing Firebase...");
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                currentProjectId = firebaseConfig.projectId;

                onAuthStateChanged(auth, async (user) => {
                    currentUser = user;
                    if (currentUser) {
                        currentUserId = currentUser.uid;

                        // Fetch username from Firestore
                        await fetchUsername(currentUserId);

                        if (currentUser.emailVerified) {
                            currentView = 'main';
                            console.log("User authenticated and email verified, setting main app view.");
                            await fetchPastGuidance(); // Fetch data after auth
                            if (conversationHistory.length === 0 || currentQuestionType === 'initial') {
                                startConversation(); // Start the AI conversation
                            }
                        } else {
                            currentView = 'verify_email';
                            email = currentUser.email; // Store email for verification message
                            console.log("User authenticated but email not verified, setting verify_email view.");
                        }
                    } else {
                        // No user signed in
                        currentView = 'login';
                        currentUser = null;
                        currentUserId = null;
                        username = ''; // Clear username on logout
                        // Clear all app-specific data on logout
                        pastGuidance = [];
                        careerGuidance = '';
                        skillPlan = '';
                        conversationHistory = [];
                        userResponses = { interests: '', skills: '', goals: '' };
                        currentQuestionType = 'initial';
                        currentUserInput = '';
                        suggestedCareers = [];
                        detailedCareerExplanation = '';
                        console.log("No user authenticated, setting auth view to login.");
                    }
                    isAuthInitialized = true; // Mark auth as initialized
                    isLoading = false; // Reset loading state here as auth flow completes
                    renderUI(); // Initial render after auth state is known
                });
            } catch (err) {
                console.error("Firebase initialization error:", err);
                let userMessage = `Failed to initialize the application: ${err.message}. Please try again later.`;
                if (err.message.includes("Firebase configuration is missing or empty")) {
                    userMessage = "Application setup incomplete: Firebase configuration is missing. Please ensure your Canvas environment provides the Firebase config.";
                } else if (err.message.includes("Invalid Firebase configuration provided")) {
                    userMessage = "Application setup incomplete: Invalid Firebase configuration. Please check the format of the provided config.";
                }
                authError = userMessage;
                currentView = 'login';
                isAuthInitialized = true;
                isLoading = false; // Reset loading state on initialization error
                renderUI();
            }
        }

        // Helper to fetch username from Firestore
        async function fetchUsername(uid) {
            if (!db || !uid || !currentProjectId) {
                console.warn("Cannot fetch username: Firestore, UID, or Project ID not available.");
                username = '';
                return;
            }
            try {
                const userDocRef = doc(db, `artifacts/${currentProjectId}/users`, uid);
                const userDocSnap = await getDoc(userDocRef);
                if (userDocSnap.exists()) {
                    username = userDocSnap.data().username || '';
                } else {
                    username = ''; // No username found
                }
            } catch (error) {
                console.error("Error fetching username:", error);
                username = '';
            }
        }


        // --- Authentication Functions ---
        async function handleLogin() {
            authError = '';
            isLoading = true;
            renderUI(); // Show loading state

            const identifier = email; // 'email' input now holds username or email
            const pass = password;

            let loginEmail = identifier; // Assume it's an email by default

            // Check if the identifier looks like an email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            const isEmail = emailRegex.test(identifier);

            if (!isEmail) {
                // If it's not an email, assume it's a username and try to find the associated email
                try {
                    const usernameDocRef = doc(db, `artifacts/${currentProjectId}/usernames`, identifier.toLowerCase());
                    const usernameDocSnap = await getDoc(usernameDocRef);
                    if (usernameDocSnap.exists()) {
                        const userData = usernameDocSnap.data();
                        if (userData.email) {
                            loginEmail = userData.email;
                            console.log(`Username '${identifier}' resolved to email: ${loginEmail}`);
                        } else {
                            authError = 'Username found, but no associated email. Please contact support.';
                            isLoading = false;
                            renderUI();
                            return;
                        }
                    } else {
                        authError = 'Username not found. Please check your username or register.';
                        isLoading = false;
                        renderUI();
                        return;
                    }
                } catch (error) {
                    console.error("Error resolving username to email:", error);
                    authError = `Error during username lookup: ${error.message}`;
                    isLoading = false;
                    renderUI();
                    return;
                }
            }

            try {
                const userCredential = await signInWithEmailAndPassword(auth, loginEmail, pass);
                // The onAuthStateChanged listener will now handle the view transition
                // based on email verification status.
                console.log("Login attempt successful, onAuthStateChanged will handle next step.");
            } catch (error) {
                console.error("Login error:", error);
                let errorMessage = error.message;
                if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Invalid email address format or username not found.';
                } else if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    errorMessage = 'Incorrect username/email or password. Please check your credentials.';
                } else if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'This email is already registered. Please login or use a different email.';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'Password is too weak. Please choose a stronger password (at least 6 characters).';
                } else if (error.code === 'auth/network-request-failed') {
                    errorMessage = 'Network error. Please check your internet connection.';
                } else if (error.code === 'auth/operation-not-allowed') {
                    errorMessage = 'Email/Password authentication is not enabled for this Firebase project. Please enable it in Firebase Console.';
                } else {
                    errorMessage = `Authentication failed: ${error.message}`;
                }
                authError = errorMessage;
                isLoading = false;
                renderUI(); // Render UI to show the error message
            }
        }

        async function handleRegister() {
            authError = '';
            isLoading = true;
            renderUI(); // Show loading state

            const newUsername = username.toLowerCase(); // Store usernames as lowercase for consistency
            const newEmail = email;
            const newPassword = password;

            if (!newUsername) {
                authError = 'Please provide a username.';
                isLoading = false;
                renderUI();
                return;
            }

            // Check if username already exists in Firestore
            try {
                const usernameDocRef = doc(db, `artifacts/${currentProjectId}/usernames`, newUsername);
                const usernameDocSnap = await getDoc(usernameDocRef);
                if (usernameDocSnap.exists()) {
                    authError = 'This username is already taken. Please choose a different one.';
                    isLoading = false;
                    renderUI();
                    return;
                }
            } catch (error) {
                console.error("Error checking username uniqueness:", error);
                authError = `Error checking username: ${error.message}`;
                isLoading = false;
                renderUI();
                return;
            }

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, newEmail, newPassword);
                currentUser = userCredential.user;

                // Store user details in Firestore
                const userDocRef = doc(db, `artifacts/${currentProjectId}/users`, currentUser.uid);
                await setDoc(userDocRef, {
                    username: newUsername,
                    email: newEmail,
                    createdAt: new Date().toISOString(),
                    uid: currentUser.uid
                });

                // Store username to UID mapping for login lookup
                const usernameMappingDocRef = doc(db, `artifacts/${currentProjectId}/usernames`, newUsername);
                await setDoc(usernameMappingDocRef, {
                    uid: currentUser.uid,
                    email: newEmail // Store email here for direct lookup
                });


                // Send email verification
                await sendEmailVerification(currentUser);
                console.log("Registration successful! Verification email sent.");
                authError = "Registration successful! Please check your email to verify your account before logging in.";
                currentView = 'login'; // Switch to login view
                // Sign out the newly registered user to force verification before login
                await signOut(auth);

            } catch (error) {
                console.error("Registration error:", error);
                let errorMessage = error.message;
                if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Invalid email address format.';
                } else if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'This email is already registered. Please login or use a different email.';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'Password is too weak. Please choose a stronger password (at least 6 characters).';
                } else if (error.code === 'auth/network-request-failed') {
                    errorMessage = 'Network error. Please check your internet connection.';
                } else if (error.code === 'auth/operation-not-allowed') {
                    errorMessage = 'Email/Password authentication is not enabled for this Firebase project. Please enable it in Firebase Console.';
                } else {
                    errorMessage = `Registration failed: ${error.message}`;
                }
                authError = errorMessage;
            } finally {
                isLoading = false;
                renderUI(); // Update UI after registration attempt
            }
        }

        async function handleLogout() {
            isLoading = true;
            renderUI();
            try {
                await signOut(auth);
                // onAuthStateChanged will handle state updates and view change
            } catch (error) {
                console.error("Logout error:", error);
                authError = "Failed to log out.";
            } finally {
                isLoading = false;
                renderUI();
            }
        }

        async function handleForgotPassword() {
            forgotPasswordMessage = '';
            isLoading = true;
            renderUI();

            if (!forgotPasswordEmail) {
                forgotPasswordMessage = { text: 'Please enter your email address.', type: 'error' };
                isLoading = false;
                renderUI();
                return;
            }
            if (!auth) {
                forgotPasswordMessage = { text: 'Firebase Auth is not initialized.', type: 'error' };
                isLoading = false;
                renderUI();
                return;
            }

            try {
                await sendPasswordResetEmail(auth, forgotPasswordEmail);
                forgotPasswordMessage = { text: 'Password reset email sent! Check your inbox.', type: 'success' };
            } catch (error) {
                console.error("Error sending password reset email:", error);
                let errorMessage = error.message;
                if (error.code === 'auth/user-not-found') {
                    errorMessage = 'No user found with that email address.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Invalid email address format.';
                } else if (error.code === 'auth/network-request-failed') {
                    errorMessage = 'Network error. Please check your internet connection.';
                }
                forgotPasswordMessage = { text: `Error: ${errorMessage}`, type: 'error' };
            } finally {
                isLoading = false;
                renderUI();
            }
        }

        async function handleResendVerificationEmail() {
            isLoading = true;
            authError = ''; // Clear previous error messages
            renderUI();

            if (!currentUser) {
                authError = 'No user logged in to resend verification email.';
                isLoading = false;
                renderUI();
                return;
            }

            try {
                await sendEmailVerification(currentUser);
                authError = 'Verification email resent! Please check your inbox.';
                // Set type to success to display green message
                // This logic is for the authErrorDiv, which is only present in login/register view
                const authErrorDivElement = document.getElementById('authError');
                if (authErrorDivElement) {
                    authErrorDivElement.classList.add('bg-green-100', 'border-green-400', 'text-green-700');
                    authErrorDivElement.classList.remove('bg-red-100', 'border-red-400', 'text-red-700');
                }
            } catch (error) {
                console.error("Error resending verification email:", error);
                authError = `Failed to resend verification email: ${error.message}`;
                // Set type to error to display red message
                const authErrorDivElement = document.getElementById('authError');
                if (authErrorDivElement) {
                    authErrorDivElement.classList.add('bg-red-100', 'border-red-400', 'text-red-700');
                    authErrorDivElement.classList.remove('bg-green-100', 'border-green-400', 'text-green-700');
                }
            } finally {
                isLoading = false;
                renderUI();
            }
        }


        // --- Firestore Data Functions ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        async function saveCareerGuidance(guidanceText) {
            if (!db || !currentUserId || !currentProjectId) {
                console.error("Firestore, User ID, or Project ID not available for saving.");
                guidanceError = "Cannot save guidance: Not logged in or database not ready.";
                renderUI();
                return;
            }

            try {
                const guidanceCollectionRef = collection(db, `artifacts/${currentProjectId}/users/${currentUserId}/careerGuidance`);
                await setDoc(doc(guidanceCollectionRef), {
                    interests: userResponses.interests,
                    skills: userResponses.skills,
                    goals: userResponses.goals,
                    guidance: guidanceText,
                    timestamp: new Date().toISOString(),
                    userId: currentUserId,
                    username: username // Save username with guidance
                });
                console.log("Career guidance saved successfully!");
                await fetchPastGuidance(); // Refresh past guidance after saving
            } catch (error) {
                console.error("Error saving career guidance:", error);
                guidanceError = "Failed to save guidance. Please try again.";
            } finally {
                renderUI();
            }
        }

        async function fetchPastGuidance() {
            if (!db || !currentUserId || !currentProjectId) {
                console.warn("Firestore, User ID, or Project ID not available for fetching past guidance.");
                pastGuidance = [];
                renderUI();
                return;
            }
            try {
                const guidanceCollectionRef = collection(db, `artifacts/${currentProjectId}/users/${currentUserId}/careerGuidance`);
                const q = query(guidanceCollectionRef);
                const querySnapshot = await getDocs(q);
                const guidanceList = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                guidanceList.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                pastGuidance = guidanceList;
            } catch (error) {
                console.error("Error fetching past guidance:", error);
                guidanceError = "Failed to load past guidance.";
            } finally {
                renderUI();
            }
        }

        async function handleDeleteGuidance(id) {
            if (!db || !currentUserId || !currentProjectId) {
                console.error("Firestore, User ID, or Project ID not available for deleting.");
                guidanceError = "Cannot delete guidance: Not logged in or database not ready.";
                renderUI();
                return;
            }
            try {
                const docRef = doc(db, `artifacts/${currentProjectId}/users/${currentUserId}/careerGuidance`, id);
                await deleteDoc(docRef);
                console.log("Guidance deleted successfully!");
                showDeleteConfirmModal = false;
                guidanceToDelete = null;
                await fetchPastGuidance(); // Refresh list
            } catch (error) {
                console.error("Error deleting guidance:", error);
                guidanceError = "Failed to delete guidance. Please try again.";
            } finally {
                renderUI();
            }
        }

        // --- Conversational AI Logic ---
        function startConversation() {
            conversationHistory = [];
            userResponses = { interests: '', skills: '', goals: '' };
            currentQuestionType = 'interests';
            careerGuidance = ''; // Clear previous guidance
            skillPlan = ''; // Clear previous skill plan
            guidanceError = '';
            skillPlanError = '';
            suggestedCareers = []; // Clear suggested careers
            detailedCareerExplanation = ''; // Clear detailed explanation
            addAIMessage("Hello! I'm your AI Career Guide. Let's find the perfect path for you. To start, what are your main career **interests**? (e.g., Technology, Creative Arts, Healthcare)");
            renderUI();
        }

        function restartConversation() {
            console.log("Restarting conversation...");
            conversationHistory = [];
            userResponses = { interests: '', skills: '', goals: '' };
            currentQuestionType = 'interests';
            careerGuidance = '';
            skillPlan = '';
            guidanceError = '';
            skillPlanError = '';
            currentUserInput = '';
            suggestedCareers = []; // Clear suggested careers
            detailedCareerExplanation = ''; // Clear detailed explanation
            startConversation(); // Re-initiate the conversation from the beginning
        }

        async function handleSendMessage() {
            const message = currentUserInput.trim();
            if (!message) return;

            conversationHistory.push({ role: 'user', text: message });
            currentUserInput = ''; // Clear input field
            isLoading = true; // Show AI typing indicator
            renderUI();

            // The API key is now hardcoded, so no need for user input validation here.
            // const apiKey = firebaseConfig.apiKey; // Using the Firebase API key as the Gemini API key

            switch (currentQuestionType) {
                case 'interests':
                    userResponses.interests = message;
                    currentQuestionType = 'skills';
                    addAIMessage("Great! Now, what are your key **skills**? (e.g., Programming, Communication, Problem-solving, Design)");
                    isLoading = false;
                    renderUI();
                    break;
                case 'skills':
                    userResponses.skills = message;
                    currentQuestionType = 'goals';
                    addAIMessage("Understood. Finally, what are your primary career **goals**? (e.g., Work remotely, High impact, Financial stability, Continuous learning)");
                    isLoading = false;
                    renderUI();
                    break;
                case 'goals':
                    userResponses.goals = message;
                    currentQuestionType = 'finished_questions';
                    addAIMessage("Thank you for providing that information! I'm now generating your personalized career guidance. This might take a moment...");
                    await generateCareerGuidanceFromAI();
                    isLoading = false;
                    renderUI();
                    break;
                case 'finished_questions':
                    // If user types a new message after initial guidance, treat it as a general query
                    await generateGeneralAIResponse(message); // New function for general AI response
                    isLoading = false;
                    renderUI();
                    break;
                default:
                    // This case should ideally not be hit if currentQuestionType is managed well
                    addAIMessage("I'm not sure how to respond to that. Let's start over if you'd like new guidance. Just type 'start over'.");
                    isLoading = false;
                    renderUI();
            }
        }

        function addAIMessage(text) {
            conversationHistory.push({ role: 'model', text: text });
        }

        // Helper function to parse suggested careers from AI response
        function parseSuggestedCareers(guidanceText) {
            const careers = [];
            const lines = guidanceText.split('\n');
            let inSuggestionsSection = false;

            for (const line of lines) {
                if (line.includes("Suggested Career Paths:")) {
                    inSuggestionsSection = true;
                    continue;
                }
                if (inSuggestionsSection && line.trim().match(/^\d+\.\s*([^:]+):/)) {
                    const match = line.trim().match(/^\d+\.\s*([^:]+):/);
                    if (match && match[1]) {
                        careers.push(match[1].trim());
                    }
                } else if (inSuggestionsSection && line.trim() === '') {
                    // Stop if we hit an empty line after the suggestions
                    // or if we hit another main heading (e.g., "General Advice:")
                    if (!line.includes("General Advice:")) { // Don't stop if it's just a blank line within the list
                         // If we have parsed some careers and hit a blank line, assume end of section
                         // This is a heuristic and might need adjustment based on AI output consistency
                         // For now, let's keep parsing until we hit a non-list item or new section
                        if (line.trim() === '' && careers.length > 0) {
                            // If we have parsed some careers and hit a blank line, assume end of section
                            // This is a heuristic and might need adjustment based on AI output consistency
                            // For now, let's keep parsing until we hit a non-list item or new section
                        }
                    }
                }
                // If we are in the suggestions section and the line doesn't match the pattern,
                // and it's not a blank line, it might be the end of the list.
                // A more robust solution might involve looking for a "General Advice:" heading.
                if (inSuggestionsSection && line.includes("General Advice:")) {
                    break; // Stop parsing if we hit the next section
                }
            }
            return careers;
        }


        // --- AI Guidance Function (using Gemini API) ---
        async function generateCareerGuidanceFromAI() {
            console.log("Generating career guidance from AI...");
            guidanceError = '';
            careerGuidance = ''; // Clear previous guidance
            suggestedCareers = []; // Clear previous suggestions
            detailedCareerExplanation = ''; // Clear previous detailed explanation

            const prompt = `Based on the following user information, provide comprehensive career guidance, including potential career paths, industries, and general advice.
Format your response to be easy to read and attractive, using:
- Clear, descriptive headings using '###' for sub-sections (e.g., '### Career Path:').
- Bullet points using '-' for lists of suggestions or actionable items.
- Shorter paragraphs (2-4 sentences max) for explanations.
- Ample line breaks to separate ideas and sections.
- Use **bold** for important terms and *italics* for emphasis.
- **IMPORTANT**: After the general guidance, provide a section specifically for "Suggested Career Paths:" as a numbered list, like "1. [Career Name]: [Brief Description]". This list should contain at least 5 distinct career suggestions.

User Interests: ${userResponses.interests}
User Skills: ${userResponses.skills}
User Career Goals: ${userResponses.goals}

Please provide at least 5 distinct career suggestions with a brief explanation for each, and then offer some general advice on career development.`;

            let chatHistoryForAPI = [];
            chatHistoryForAPI.push({ role: "user", parts: [{ text: prompt }] });
            const payload = { contents: chatHistoryForAPI };
            // Use the hardcoded API key from firebaseConfig
            const apiKey = firebaseConfig.apiKey;
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API error: ${response.status} ${response.statusText} - ${errorData.error?.message || 'Unknown error'}`);
                }

                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    careerGuidance = text;
                    suggestedCareers = parseSuggestedCareers(text); // Parse careers from the generated text
                    addAIMessage("Here is your personalized career guidance:");
                    addAIMessage(text); // Add the full guidance to chat history
                    await saveCareerGuidance(text); // Save the generated guidance
                } else {
                    careerGuidance = "No guidance could be generated. Please try rephrasing your input.";
                    guidanceError = "Failed to get a valid response from the AI model.";
                    addAIMessage("I apologize, but I couldn't generate guidance. Please try again with different input.");
                }
            } catch (error) {
                console.error("Error generating career guidance:", error);
                guidanceError = `Failed to generate career guidance: ${error.message}. Please try again.`;
                addAIMessage(`An error occurred: ${error.message}. Please check your API setup or try again later.`);
            } finally {
                isLoading = false;
                renderUI();
                console.log("generateCareerGuidanceFromAI finished.");
            }
        }

        // New: Function to handle career selection and generate detailed explanation
        async function handleCareerSelection(careerName) {
            console.log(`Generating detailed explanation for: ${careerName}`);
            isGeneratingDetailedExplanation = true;
            detailedCareerExplanation = ''; // Clear previous explanation
            renderUI();

            addAIMessage(`Generating a detailed explanation for **${careerName}**...`);

            const prompt = `Provide a detailed explanation for the career path: "${careerName}".
Consider the user's initial interests: "${userResponses.interests}", skills: "${userResponses.skills}", and goals: "${userResponses.goals}".
Elaborate on:
- What the role entails day-to-day.
- Key responsibilities.
- Essential skills required (both technical and soft skills).
- Typical educational background or certifications.
- Potential growth opportunities and related roles.
- Industry outlook.
Format your response to be easy to read and attractive, using:
- Clear, descriptive headings using '###' for sub-sections (e.g., '### Day-to-Day Responsibilities:').
- Bullet points using '-' for lists of suggestions or actionable items.
- Shorter paragraphs (2-4 sentences max) for explanations.
- Ample line breaks to separate ideas and sections.
- Use **bold** for important terms and *italics* for emphasis.`;

            let chatHistoryForAPI = [];
            chatHistoryForAPI.push({ role: "user", parts: [{ text: prompt }] });
            const payload = { contents: chatHistoryForAPI };
            const apiKey = firebaseConfig.apiKey; // Use the hardcoded API key
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API error: ${response.status} ${response.statusText} - ${errorData.error?.message || 'Unknown error'}`);
                }

                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    detailedCareerExplanation = text;
                    addAIMessage(`Here's a detailed explanation for **${careerName}**:`);
                    addAIMessage(text);
                } else {
                    detailedCareerExplanation = `Could not generate a detailed explanation for ${careerName}. Please try again.`;
                    addAIMessage(`I apologize, but I couldn't generate a detailed explanation for ${careerName}.`);
                }
            } catch (error) {
                console.error("Error generating detailed career explanation:", error);
                detailedCareerExplanation = `Failed to generate detailed explanation: ${error.message}. Please try again.`;
                addAIMessage(`An error occurred while getting details for ${careerName}: ${error.message}.`);
            } finally {
                isGeneratingDetailedExplanation = false;
                renderUI();
                console.log("handleCareerSelection finished.");
            }
        }

        // New: Function to handle general AI responses
        async function generateGeneralAIResponse(userQuery) {
            console.log("Generating general AI response...");
            isLoading = true; // Set loading for general query
            renderUI();

            const prompt = `The user has already received career guidance based on their interests: "${userResponses.interests}", skills: "${userResponses.skills}", and goals: "${userResponses.goals}". They are now asking a follow-up question or making a general statement. Respond to the following user query in a helpful and conversational manner. Keep your response concise but informative. Use Markdown for formatting (e.g., **bold**, *italics*, lists if appropriate).

User's current query: "${userQuery}"`;

            let chatHistoryForAPI = [];
            // Include some recent conversation history for context, if available
            const recentChat = conversationHistory.slice(-5); // Last 5 messages for context
            recentChat.forEach(msg => {
                chatHistoryForAPI.push({ role: msg.role === 'user' ? 'user' : 'model', parts: [{ text: msg.text }] });
            });
            chatHistoryForAPI.push({ role: "user", parts: [{ text: prompt }] });

            const payload = { contents: chatHistoryForAPI };
            const apiKey = firebaseConfig.apiKey; // Use the hardcoded API key
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API error: ${response.status} ${response.statusText} - ${errorData.error?.message || 'Unknown error'}`);
                }

                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    addAIMessage(text);
                } else {
                    addAIMessage("I'm sorry, I couldn't generate a response to that. Please try rephrasing your question.");
                }
            } catch (error) {
                console.error("Error generating general AI response:", error);
                addAIMessage(`An error occurred: ${error.message}. Please try again later.`);
            } finally {
                isLoading = false;
                renderUI();
                console.log("generateGeneralAIResponse finished.");
            }
        }


        // --- AI Skill Development Plan Function (using Gemini API) ---
        async function handleGetSkillPlan() {
            console.log("handleGetSkillPlan called.");
            isSkillPlanLoading = true;
            skillPlan = '';
            skillPlanError = '';
            renderUI();

            const currentGuidance = careerGuidance;
            const currentSkills = userResponses.skills; // Use the skills from userResponses

            if (!currentGuidance) {
                skillPlanError = "Please generate career guidance first before requesting a skill development plan.";
                addAIMessage("Please generate career guidance first before requesting a skill development plan.");
                isSkillPlanLoading = false;
                renderUI();
                return;
            }
            if (!currentSkills) {
                skillPlanError = "Please provide your current skills in the chat above to generate a relevant plan.";
                addAIMessage("Please provide your current skills in the chat above to generate a relevant plan.");
                isSkillPlanLoading = false;
                renderUI();
                return;
            }

            addAIMessage("Generating your skill development plan. This may take a moment...");

            const prompt = `Based on the following career guidance and the user's current skills, create a detailed skill development plan.
Format your response to be easy to read and attractive, using:
- Clear, descriptive headings using '###' for sub-sections (e.g., '### Learning Resources:').
- Bullet points using '-' for lists of suggestions or actionable items.
- Shorter paragraphs (2-4 sentences max) for explanations.
- Ample line breaks to separate ideas and sections.
- Use **bold** for important terms and *italics* for emphasis.

Career Guidance: ${currentGuidance}
User's Current Skills: ${currentSkills}

Please make the plan practical and actionable.`;

            let chatHistoryForAPI = [];
            chatHistoryForAPI.push({ role: "user", parts: [{ text: prompt }] });
            const payload = { contents: chatHistoryForAPI };
            const apiKey = firebaseConfig.apiKey; // Use the hardcoded API key
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API error: ${response.status} ${response.statusText} - ${errorData.error?.message || 'Unknown error'}`);
                }

                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    skillPlan = text;
                    addAIMessage("Here is your personalized skill development plan:");
                    addAIMessage(text); // Add the full plan to chat history
                } else {
                    skillPlan = "No skill development plan could be generated. Please try again.";
                    skillPlanError = "Failed to get a valid response from the AI model.";
                    addAIMessage("I apologize, but I couldn't generate a skill plan. Please try again.");
                }
            } catch (error) {
                console.error("Error generating skill plan:", error);
                skillPlanError = `Failed to generate skill development plan: ${error.message}. Please try again.`;
                addAIMessage(`An error occurred: ${error.message}. Please check your API setup or try again later.`);
            } finally {
                isSkillPlanLoading = false;
                renderUI();
                console.log("handleGetSkillPlan finished.");
            }
        }

        // --- Initial Setup on Window Load ---
        window.onload = function() {
            console.log("Window loaded, initializing Firebase.");
            initializeFirebase();
            // renderUI will be called by onAuthStateChanged after Firebase init
        };
    </script>
</body>
</html>
